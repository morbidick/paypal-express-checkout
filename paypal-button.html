<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="paypal-button">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <a href="#" on-click="_openWindow"><slot>Paypal</slot></a>

    </template>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     * @extends {Polymer.Element}
     */
    class PaypalButton extends Polymer.Element {
      static get is() { return 'paypal-button'; }

      static get properties() {
        return {
          // whether to use sandbox mode
          sandbox: {
            type: Boolean,
            reflectToAttribute: true,
            value: false,
          },
          // sandbox client id (https://developer.paypal.com/developer/applications/create)
          sandboxId: {
            type: String,
          },
          // production client id
          productionId: {
            type: String,
          },
          // amount to charge
          amount: {
            type: Number,
          },
          // amount currency
          currency: {
            type: String,
            value: 'EUR',
          },
          // payment reference (optional)
          reference: {
            type: String,
          },
          // whether events bubble
          bubbles: {
            type: Boolean,
            value: false,
          },
          response: {
            type: Object,
            notify: true,
            readonly: true,
          },
          _window: {
            type: Object,
          },
          _handler: {
            type: Object,
          }
        };
      }

      open() {
        this._openWindow();
      }

      disconnectedCallback() {
        window.removeEventListener("message", this._handler);
      }

      _openWindow() {
        this._handler = this._eventHandler.bind(this);
        window.addEventListener("message", this._handler);
        this._window = window.open(`${this.resolveUrl("paypal.html")}?env=${this._env()}&sandboxId=${this.sandboxId}&productionId=${this.productionId}`);
      }

      // data bridge recieving
      _eventHandler(event) {
        switch(event.data.type) {
          case "paypal-window-rendered":
            this._updatePaypalData();
            break;
          case "paypal-window-success":
            window.removeEventListener("message", this._handler);
            this.response = event.data.data;

            /**
             * @event paypal-success Fired on succesful checkout.
             */
            this.dispatchEvent(new CustomEvent('paypal-success', {
              detail: event.data.data,
              bubbles: this.bubbles,
              composed: true,
            }));
            break;
          case "paypal-window-error":
            window.removeEventListener("message", this._handler);
            /**
             * @event paypal-error Fired on succesful checkout.
             */
            this.dispatchEvent(new CustomEvent('paypal-error', {
              detail: event.data.data,
              bubbles: this.bubbles,
              composed: true,
            }));
            break;
          default:
            // do nothing
        }
      }

      _updatePaypalData() {
        this._window.postMessage({
          type: "paypal-window-data",
          payment: {
            amount: this.amount,
            currency: this.currency,
            reference: this.reference,
          }
        }, "*");
      }

      _env() {
        return this.sandbox ? 'sandbox' : 'production';
      }
    }

    customElements.define(PaypalButton.is, PaypalButton);
  </script>
</dom-module>
