<head>
  <script src="https://www.paypalobjects.com/api/checkout.js"></script>
  <script>
  var searchParams = new URLSearchParams(window.location.search);
  var bridgeTimeoutHandler;

  function sendMessage(type, data) {
    if (window.opener) {
      window.opener.postMessage({
        type,
        data
      }, "*");
    }
  }

  // helper to append params to an url
  function appendUrlParam(url, paramString) {
    var url = url || '';

    if (paramString) {
      var bindingChar = url.indexOf('?') >= 0 ? '&' : '?';
      return url + bindingChar + paramString;
    }

    return url;
  }

  // data bridge recieving
  window.addEventListener("message", (event) => {
    switch (event.data.type) {
      case "paypal-window-success-ack":
        window.clearTimeout(bridgeTimeoutHandler);
        window.close();
        break;
      case "paypal-window-close-ack":
        window.close();
        break;
      case "paypal-window-error-ack":
        window.close();
        break;
      default:
        // do nothing
    }
  });

  var button = paypal.Button.render({

    env: searchParams.get("env"),

    // PayPal Client IDs - replace with your own
    // Create a PayPal app: https://developer.paypal.com/developer/applications/create
    client: {
      sandbox:    searchParams.get("sandboxId"),
      production: searchParams.get("productionId"),
    },

    // Show the buyer a 'Pay Now' button in the checkout flow
    commit: true,

    onDisplay: function(data) {
      sendMessage("paypal-window-rendered");
    },

    // payment() is called when the button is clicked
    payment: (data, actions) => {
      // Make a call to the REST api to create the payment
      return actions.payment.create({
        payment: {
          transactions: [
            {
              amount: { total: searchParams.get("amount"), currency: searchParams.get("currency") },
              custom: searchParams.get("reference"),
            },
          ],
          redirect_urls: {
            return_url: appendUrlParam(searchParams.get("referer"), "paypal-window-success"),
            cancel_url: appendUrlParam(searchParams.get("referer"), "paypal-window-close"),
          },
        },
      });
    },

    // onAuthorize() is called when the buyer approves the payment
    onAuthorize: (data, actions) => {
      // Make a call to the REST api to execute the payment
      return actions.payment.execute().then( () => {
        // detect dead bridge and redirect
        bridgeTimeoutHandler = window.setTimeout(function() {
          let paypalData = new URLSearchParams();
          // mapping according to how paypal is handling the return_url
          paypalData.set("paymentId", data.paymentID);
          paypalData.set("token", data.paymentToken);
          paypalData.set("PayerID", data.payerID);

          document.location = appendUrlParam(searchParams.get("referer"), `paypal-window-success&${paypalData.toString()}`);
        }, 1000);

        // send success via bridge
        sendMessage("paypal-window-success", data);
      });
    },

    onCancel: (data, actions) => {
      sendMessage("paypal-window-close");
    },

    onError: (error) => {
      sendMessage("paypal-window-error", error);
    },

  }, "#container");

  </script>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .centered {
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="centered">
    <h1>Paypal express checkout</h1>
    <div id="container"></div>
  </div>
</body>
